{"version":3,"file":"index.browser.js","sources":["../src/client-manager/index.ts"],"sourcesContent":["import {\n  ClientOptions, ClientState\n} from './interfaces';\n\nexport default class ClientJWTSessionManager {\n  state: ClientState = {\n    sessionToken: null,\n  };\n\n  clientOptions: ClientOptions = {\n    getSessionRequestTokenHandler: async () => '',\n    getSessionHandler: async () => '',\n  };\n\n  constructor(options: ClientOptions, restoreState?: ClientState) {\n    this.clientOptions = {\n      ...this.clientOptions,\n      ...options,\n    };\n\n    restoreState\n    && this.setState(restoreState);\n  }\n\n  setState = (newState: ClientState) => {\n    const prevState: ClientState = this.state;\n\n    this.state = {\n      ...prevState,\n      ...newState,\n    };\n  };\n\n  getSessionRequestToken = async (): Promise<void> => {\n    const {\n      clientOptions,\n      setState,\n    } = this;\n\n    const {\n      getSessionRequestTokenHandler,\n      storeSessionRequestTokenHandler,\n    } = clientOptions;\n\n    const requestTokenResponse = await getSessionRequestTokenHandler().catch((e) => {throw e;});\n\n    setState({\n      sessionRequestToken: requestTokenResponse,\n    });\n\n    storeSessionRequestTokenHandler\n    && await storeSessionRequestTokenHandler(this.state.sessionRequestToken).catch((e) => {throw e;});\n\n    return;\n  };\n\n  get sessionToken(): string {\n    return this.state.sessionToken;\n  };\n\n  getSession = async (): Promise<void> => {\n    const {\n      clientOptions,\n      getSessionRequestToken,\n      setState,\n    } = this;\n\n    const {\n      getSessionHandler,\n      storeSessionTokenHandler,\n    } = clientOptions;\n\n    if (!this.state.sessionRequestToken) {\n      await getSessionRequestToken();\n    }\n\n    const sessionToken = await getSessionHandler(this.state.sessionRequestToken).catch(async (error) => {\n      if (error.name !== 'TokenExpiredError') {\n        throw error;\n      }\n\n      // If token is expired simply retry once as it may be an invalid stored token\n      await getSessionRequestToken().catch((e) => {throw e;});\n\n      return await getSessionHandler(this.state.sessionRequestToken).catch((e) => {throw e;});\n    }).catch((e) => {throw e;});\n\n    setState({\n      sessionToken\n    });\n\n    storeSessionTokenHandler\n    && await storeSessionTokenHandler(this.sessionToken).catch((e) => {throw e;});\n\n    return;\n  };\n\n  closeSession = async (): Promise<void> => {\n    const {\n      clientOptions,\n      setState,\n    } = this;\n\n    const {\n      closeSessionHandler,\n    } = clientOptions;\n\n    closeSessionHandler\n    && await closeSessionHandler(this.sessionToken).catch((e) => {throw e;});\n\n    setState({\n      sessionToken: null,\n    });\n\n    return;\n  };\n};\n"],"names":[],"mappings":"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"}